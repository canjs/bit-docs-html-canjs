<!DOCTYPE html>
<!--####################################################################
	THIS IS A GENERATED FILE -- ANY CHANGES MADE WILL BE OVERWRITTEN

	INSTEAD CHANGE:
	source: [object Object]
	@page guides/recipes/weather-report-advanced
######################################################################## -->
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>CanJS - Weather Report Guide (Advanced)</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	
		<link rel="stylesheet" type="text/css" href="../../static/bundles/bit-docs-site/static.css">
		<link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64" href="/docs/images/canjs_favicon.ico">
		<link rel="apple-touch-icon" sizes="57x57" href="../../../docs/images/canjs_favicon_57x57.png">
		<link rel="apple-touch-icon-precomposed" sizes="57x57" href="../../../docs/images/canjs_favicon_57x57.png">
		<link rel="apple-touch-icon" sizes="72x72" href="../../../docs/images/canjs_favicon_72x72.png">
		<link rel="apple-touch-icon" sizes="114x114" href="../../../docs/images/canjs_favicon_114x114.png">
		<link rel="apple-touch-icon" sizes="120x120" href="../../../docs/images/canjs_favicon_128x128.png">
		<link rel="apple-touch-icon" sizes="144x144" href="../../../docs/images/canjs_favicon_144x144.png">
		<link rel="apple-touch-icon" sizes="152x152" href="../../../docs/images/canjs_favicon_152x152.png">
		<meta content="yes" name="apple-mobile-web-app-capable">
	  	<meta name="apple-mobile-web-app-status-bar-style" content="white-translucent">
	
	
		<script>
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
				(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
				m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

			ga('create', 'UA-2302003-11', 'auto');
			ga('send', 'pageview');
		</script>
	
</head>
	<body>
		<input type="checkbox" id="nav-trigger" class="nav-trigger"/>
		<label for="nav-trigger">Menu</label>
	  	<div id="everything">
  <div id="left" class="column">
    <div class="top-left">
      
          <div class="brand">
	<div class="logo">
		<a href="../../../index.html" alt="CanJS"></a>
		<div class="dropdown project-dropdown">
			<a href="https://donejs.com/">DoneJS</a>
			<a href="https://stealjs.com/">StealJS</a>
			<a href="https://jquerypp.com/">jQuery++</a>
			<a href="https://funcunit.com/">FuncUnit</a>
			<a href="https://documentjs.com/">DocumentJS</a>
		</div>
	</div>
	<div class="version">
		<div class="version-number">
			3.8.1
		</div>
		<div class="dropdown version-dropdown">
			
				<a href="https://v2.canjs.com">2.3.27</a>
			
		</div>
	</div>
</div>
<div class="search-bar">
	<div class="search-wrap" style="display:none;">
		<span class="search-icon"></span>
		<input
			type="text"
			size="6"
			class="search"
			placeholder="Search"
			autocomplete="off"
			autocorrect="off"
			autocapitalize="none"
			spellcheck="false"/>
			<span class="search-icon-cancel"></span>
	</div>
</div>


      
    </div>
    <div class="bottom-left">
       <div class="social-side-container">
        <ul class="social-side">
  <li>
    <a class="header-mobile github" href="https://github.com/canjs/canjs" target="_blank"><img class="social-icon-small" src="../../../docs/images/github.png">Github</a>
  </li>
  <li>
    <a class="header-mobile twitter" href="https://twitter.com/canjs" target="_blank"><img class="social-icon-small" src="../../../docs/images/twitter.png">Twitter</a>
  </li>
</ul>
<ul class="social-side">
  <li>
    <a class="header-mobile" href="https://gitter.im/canjs/canjs" target="_blank">Chat</a>
  </li>
  <li>
    <a class="header-mobile" href="http://forums.donejs.com/c/canjs" target="_blank">Forum</a>
  </li>
</ul>

      </div>
        
            
	<ul>
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../../about.html"
							title="Welcome to CanJS! Learn about CanJS’s mission &amp; technical highlights, who uses CanJS, and our future roadmap.">
							About
						</a>
						

					</li>
				
			
		
			
				
					<li class="
           						parent
           						expanded">
						<a class="page"
							href="../../guides.html"
							title="Welcome to CanJS! These guides are here to help you develop and improve your relationship with CanJS. After all, picking a JavaScript framework is a commitment.  We want CanJS to be the framework you marry.  This page helps you know how to advance through the different stages of this relationship:">
							Guides
						</a>
						
	<ul>
		
			
				
					<li>
						<span>experiment</span>
						
	<ul>
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../chat.html"
							title="This guide will walk you through building a real-time chat application with CanJS’s Core libraries.  It takes about 30 minutes to complete.">
							Chat Guide
						</a>
						

					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../todomvc.html"
							title="This guide will walk you through building a slightly modified version of TodoMVC with CanJS’s Core libraries and can-fixture. It takes about 1 hour to complete.">
							TodoMVC Guide
						</a>
						

					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../atm.html"
							title="This guide will walk you through building and testing an Automated Teller Machine (ATM) application with CanJS’s
Core libraries.  You’ll learn how to do test driven development (TDD)
and manage complex state.  It takes about 2 hours to complete.">
							ATM Guide
						</a>
						

					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../setup.html"
							title="Get started with CanJS by installing it with npm, using a JS&amp;nbsp;Bin, or just adding it to an HTML page with a &lt;script&gt; tag.">
							Setting up CanJS
						</a>
						

					</li>
				
			
		
	</ul>


					</li>
				
			
		
			
				
					<li>
						<span>commitment</span>
						
	<ul>
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../api.html"
							title="This page walks through how to use and understand CanJS’s API documentation.">
							API Guide
						</a>
						

					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../../migrate-3.html"
							title="This guide walks you through the step-by-step process to upgrade a 2.x app to CanJS 3.">
							Migrating to CanJS 3
						</a>
						

					</li>
				
			
		
			
				
					<li class="
           						parent
           						expanded">
						<a class="page"
							href="../recipes.html"
							title="A listing of small examples that are useful for learning CanJS.">
							Recipes
						</a>
						
	<ul>
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="file-navigator-advanced.html"
							title="This guide walks you through building a file navigation widget.  It takes about 45 minutes to complete.  It was written with
CanJS 3.4. Checkout the file-navigator-simple
for an easier example that produces similar functionality.">
							File Navigator Guide (Advanced)
						</a>
						

					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="file-navigator-simple.html"
							title="This guide walks you through building a simple file navigation widget.  It takes about 25 minutes to complete.  It was written with
CanJS 3.4. Checkout the file-navigator-advanced
for an example that makes AJAX requests for its data and uses can-component.">
							File Navigator Guide (Simple)
						</a>
						

					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="playlist-editor.html"
							title="Learn how to use YouTube&#x27;s API to search for videos and make a playlist.  This makes authenticated requests with OAuth2. It uses jQuery++ for
drag/drop events. It shows using custom attributes and custom events.  This guide takes
an hour to complete.">
							Playlist Editor (Advanced)
						</a>
						

					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="todomvc-with-steal.html"
							title="This guide walks through building TodoMVC with StealJS.">
							TodoMVC with StealJS
						</a>
						

					</li>
				
			
		
			
				
					<li class="current
           						parent
           						expanded">
						<a class="page"
							href="weather-report-advanced.html"
							title="This guides you through extending the Simple Weather Report Guide to remove imperative code and automatically look up the user’s location using the
browser’s geolocation API.  Both of these will be done with event streams.
This guide continues where the Simple Weather Report Guide left off.  It takes about 25 minutes to complete.  It was written with CanJS 3.8.">
							Weather Report Guide (Advanced)
						</a>
						

					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="weather-report-simple.html"
							title="This guide walks you through building a simple weather report widget.  It takes about 25 minutes to complete.  It was written with
CanJS 3.5.">
							Weather Report Guide (Simple)
						</a>
						

					</li>
				
			
		
	</ul>


					</li>
				
			
		
	</ul>


					</li>
				
			
		
			
				
					<li>
						<span>contribute</span>
						
	<ul>
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../contributing/adding-ecosystem-modules.html"
							title="Learn how to add your module to this site.">
							New Package
						</a>
						

					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../contributing/bug-report.html"
							title="Learn how to submit a bug report.">
							Bug Report
						</a>
						

					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../contributing/code.html"
							title="Learn how contribute a code change to CanJS.">
							Code
						</a>
						

					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../contributing/documentation.html"
							title="Learn how to improve CanJS’s site and documentation.">
							Documentation
						</a>
						

					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../contributing/evangelism.html"
							title="Learn about resources that can help you spread the word about CanJS.">
							Evangelism
						</a>
						

					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../contributing/feature-suggestion.html"
							title="Learn how to suggest a feature.">
							Feature Suggestion
						</a>
						

					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../contributing/releases.html"
							title="Release and hosting information for CanJS maintainers.">
							Releases
						</a>
						

					</li>
				
			
		
	</ul>


					</li>
				
			
		
	</ul>


					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../../api.html"
							title="Welcome to the CanJS docs! Learn about all the packages that make-up CanJS &amp; how they work together to help you build amazing applications!">
							API Docs
						</a>
						

					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../../community.html"
							title="Get involved with one of the most inviting communities on the internet!">
							Community
						</a>
						

					</li>
				
			
		
	</ul>


        
        <div class="search-results-container">
	<div class="search-results-wrap"></div>
</div>

    </div>
  </div>
  <div id="right" class="column">
    <div class="top-right">
      <div class="top-right-top">
	<ul class="top-right-bitovi">
	  	<li class="dropdown">
	    	<a href="https://www.bitovi.com" class="bitovi icon-bits">Bitovi</a>
	    	<ul class="dropdown-menu">
	      		<li><a href="https://www.bitovi.com/">Bitovi.com</a></li>
	      		<li><a href="https://www.bitovi.com/blog">Blog</a></li>
	      		<li><a href="https://www.bitovi.com/design">Design</a></li>
	      		<li><a href="https://www.bitovi.com/development">Development</a></li>
	      		<li><a href="https://www.bitovi.com/training">Training</a></li>
	      		<li><a href="https://www.bitovi.com/open-source">Open Source</a></li>
	      		<li><a href="https://www.bitovi.com/about">About</a></li>
	      		<li><a href="https://www.bitovi.com/contact">Contact Us</a></li>
	    	</ul>
	  	</li>
	</ul>
	<div class="brand">
		<div class="logo">
			<a href="../../../index.html" alt="CanJS"></a>
		</div>
	</div>
	<ul class="top-right-links">
  <li>
    <a href="https://gitter.im/canjs/canjs">Chat</a>
  </li>
  <li>
    <a href="http://forums.donejs.com/c/canjs">Forum</a>
  </li>
  <li>
    <a class="github-button nav-social" href="https://github.com/canjs/canjs" data-count-href="/canjs/canjs/stargazers" data-count-api="/repos/canjs/canjs#stargazers_count">Star</a>
  </li>
  <li>
    <a href="https://twitter.com/canjs" class="twitter-follow-button nav-social" data-show-count="true" data-show-screen-name="false">Follow @canjs</a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </li>
</ul>
</div>
<div class="breadcrumb">
	
		<li><a href="../../../index.html">CanJS</a></li>
		<li> / </li>
	
		<li><a href="../../guides.html">Guides</a></li>
		<li> / </li>
	
		<li><a href="../recipes.html">Recipes</a></li>
		<li> / </li>
	
	
	<li><a href="weather-report-advanced.html">Weather Report Guide (Advanced)</a></li>
	
	<li class="breadcrumb-dropdown-separator"> / </li>
	<li class="breadcrumb-dropdown">
		<a> On this page</a>
		<ul class="on-this-page"></ul>
	</li>
	<div class="nav-toggle" title="Back to top"></div>
</div>


    </div>
    <div class="bottom-right">
      <article>
  <section class="title">
	<div class="page-type">
		<h1>Weather Report Guide (Advanced)</h1>
			<ul class="title-social">
				
				
				<li>
					<a class="button-link" href="//github.com/canjs/canjs/edit/master/docs/can-guides/commitment/recipes/weather-report/weather-report-advanced.md">Edit on GitHub</a>
				</li>
				
			</ul>
	</div>
	<div class="clear-both"></div>
	
  
	<section class="description">
    <p>This guides you through extending the <a href="weather-report-simple.html" title="This guide walks you through building a simple weather report widget.  It takes about 25 minutes to complete.  It was written with
CanJS 3.5.">Simple Weather Report Guide</a> to remove imperative code and automatically look up the user’s location using the
browser’s <a href="https://developer.mozilla.org/en-US/docs/Web/API/Geolocation/Using_geolocation">geolocation API</a>.  Both of these will be done with event streams.</p>
<p>This guide continues where the <a href="weather-report-simple.html" title="This guide walks you through building a simple weather report widget.  It takes about 25 minutes to complete.  It was written with
CanJS 3.5.">Simple Weather Report Guide</a> left off.  It takes about 25 minutes to complete.  It was written with CanJS 3.8.</p>

</section>

  
	
</section>
<section class="on-this-page-table">
</section>











  
    <section class="body">
    <p>The final widget looks like:</p>
<p><a class="jsbin-embed" href="https://jsbin.com/jipevu/2/embed?html,js,output">JS Bin on jsbin.com</a></p>
<p><strong>Start this tutorial by cloning the following JS Bin</strong>:</p>
<p><a class="jsbin-embed" href="https://jsbin.com/qowacac/2/embed?html,js,output">JS Bin on jsbin.com</a></p>
<p>This is the ending JS Bin for the <a href="weather-report-simple.html" title="This guide walks you through building a simple weather report widget.  It takes about 25 minutes to complete.  It was written with
CanJS 3.5.">Simple Weather Report Guide</a> with <a href="https://rpominov.github.io/kefir/">Kefir.js</a> added.</p>
<p>The following sections are broken down into:</p>
<ul>
<li>Problem — A description of what the section is trying to accomplish.</li>
<li>Things to know — Information about CanJS that is useful for solving the problem.</li>
<li>Solution — The solution to the problem.</li>
</ul>
<h2>Removing Imperative Code</h2>
<h3>The problem</h3>
<p>Currently, when a new <code>location</code> is set, the <code>place</code> property is set to <code>null</code>:</p>
<pre><code class="language-js">var WeatherViewModel = can.DefineMap.extend({
  location: {
    type: &quot;string&quot;,
    set: function(){
      this.place = null;
    }
  },
  ...
});
</code></pre>
<p>This is <a href="https://en.wikipedia.org/wiki/Imperative_programming">imperative code</a>.
It uses side-effects to change the value
of <code>place</code> when <code>location</code> is changed.  The rules for how <code>place</code> behaves are not
defined in one place, which makes the code harder to follow.</p>
<p>Instead, we want to completely define the behavior of <code>place</code> within the place definition, which looks like
this:</p>
<pre><code class="language-js">var WeatherViewModel = can.DefineMap.extend({
  ...
  place: {
    type: &quot;any&quot;,
    get: function(lastSet){
      if(lastSet) {
        return lastSet;
      } else {
        if(this.places &amp;&amp; this.places.length === 1) {
          return this.places[0];
        }
      }
    }
  },
  ...
});
</code></pre>
<p>We want to define the behavior of <code>place</code> so that it becomes <code>null</code> when <code>location</code> changes.</p>
<h3>Things to know</h3>
<ul>
<li><p><code>DefineMap</code> <a href="../../can-define.types.get.html" title="Specify what happens when a certain property is read on a map. get functions
work like a can-compute and automatically update themselves when a dependent
observable value is changed.">getters</a> can only derive a value from other values.  They can’t
derive a value from the change in other values.  However, event-stream libraries like <a href="https://rpominov.github.io/kefir/">KefirJS</a>
can do this.</p>
<p>For example, we can create a <code>Kefir</code> stream that counts the number of times the following <code>person</code> map’s <code>name</code>
property changes using the <a href="../../can-stream-kefir.html" title="Convert observable values into streams. Kefir is used to provide the stream functionality.">can-stream-kefir</a> module as follows:</p>
<pre><code class="language-js">var person = new can.DefineMap({name: &quot;Justin&quot;});

// Create a stream from person’s name
var nameStream = can.streamKefir.toStream(person,&quot;.name&quot;);

// Every time `.name` changes, increase the count 1.
var nameChangeCountStream = nameStream.scan(function(lastValue){
    return lastValue + 1;
}, 0);

// Log the current nameChangeStream value
nameChangeStream.onValue(function(newValue){
    console.log(newValue);
});

person.name = &quot;Ramiya&quot; // logs 1

person.name = &quot;Payal&quot;  // logs 2
</code></pre></li>
<li><p>The <code>toStream</code> method can take an observable object and a property (or event) and create an event stream. The following creates a stream of the <code>person.name</code> property values:</p>
<pre><code class="language-js">var person = new can.DefineMap({name: &quot;Justin&quot;});
var nameStream = can.streamKefir.toStream(person,&quot;.name&quot;);

nameStream.onValue(function(newValue){
    console.log(newValue);
});

person.name = &quot;Ramiya&quot; // logs &quot;Ramiya&quot;
person.name = &quot;Payal&quot; // logs &quot;Payal&quot;
</code></pre></li>
<li><p>Kefir’s <a href="https://rpominov.github.io/kefir/#map">map</a> method can be used to convert event-stream values into new values.  The following creates an event stream of upper-cased names:</p>
<pre><code class="language-js">var person = new can.DefineMap({name: &quot;Justin&quot;});
var capitalizedNameStream = can.streamKefir.toStream(person,&quot;.name&quot;)
  .map(function(name){
      return name.toUpperCase()
  });

nameStream.onValue(function(newValue){
    console.log(newValue);
});

person.name = &quot;Ramiya&quot; // logs &quot;RAMIYA&quot;
person.name = &quot;Payal&quot; // logs &quot;PAYAL&quot;
</code></pre></li>
<li><p>The <a href="../../can-define-stream-kefir.html" title="Exports a function that takes a Type map or list and uses can-stream-kefir to create a streaming object">can-define-stream-kefir</a> module lets you define a property value using
a stream. For example, we can define a <code>nameChangeCount</code> property of a <code>Person</code> type using <code>stream</code> like:</p>
<pre><code class="language-js">Person = can.DefineMap.extend({
    name: &quot;string&quot;,
    nameChangeCount: {
        stream: function(){
            return this.toStream(&quot;.name&quot;).scan(function(lastValue){
                return lastValue + 1;
            }, 0);
        }
    }
});
can.defineStreamKefir(Person);
</code></pre>
<p>Notice that the <a href="../../can-define-stream-kefir.html" title="Exports a function that takes a Type map or list and uses can-stream-kefir to create a streaming object">can-define-stream-kefir</a> module is used as a <a href="https://developer.mozilla.org/en-US/docs/Glossary/Mixin">mixin</a>. When called on a type (like <code>Person</code>), the mixin
looks for <a href="../../can-define.types.propDefinition.html" title="Defines the type, initial value, and get, set, and serialize behavior for an
observable property.  These behaviors can be specified with as an Object, String,
Constructor function, Array, a getter expression, or setter expression.">PropDefinition</a>s with <code>stream</code>
property definition functions.  It uses the stream instance returned by the <code>stream</code> property definition function as the value of the property.</p>
<p>Stream properties, like asynchronous getters, only have a value when
bound to.  To read the <code>nameChangeCount</code>, first use <code>.on</code> like:</p>
<pre><code class="language-js">var me = new Person({name: &quot;Justin&quot;});
me.on(&quot;nameChangeCount&quot;, function(ev, newValue){
    console.log(newValue);
});

me.nameChangeCount //-&gt; 0

me.name = &quot;Ramiya&quot; // logs 1

me.nameChangeCount //-&gt; 1
</code></pre></li>
<li><p>The <code>stream</code> property definition function is passed <code>setStream</code> which is
a stream of values set on the property.  The following allows a
user to set <code>nameChangeCount</code> to reset the count at some new value:</p>
<pre><code class="language-js">Person = can.DefineMap.extend({
  name: &quot;string&quot;,
  nameChangeCount: {
      stream: function(setStream){
          var reset = setStream.map(function(value){
              return {type: &quot;reset&quot;, value: value};
          });
          var increment = this.toStream(&quot;.name&quot;).map(function(){
              return {type: &quot;increment&quot;}
          });

          return reset.merge(increment).scan(function(lastValue, next){
              if(next.type === &quot;increment&quot;) {
                  return lastValue + 1;
              } else {
                  return next.value;
              }
          }, 0);
      }
  }
});
can.defineStreamKefir(Person);
</code></pre>
<p>The following shows the behavior of this property:</p>
<pre><code class="language-js">var me = new Person({name: &quot;Justin&quot;});
me.on(&quot;nameChangeCount&quot;, function(ev, newValue){
  console.log(newValue);
});

me.nameChangeCount = 10;

me.name = &quot;Ramiya&quot; // logs 11

me.nameChangeCount //-&gt; 11
</code></pre></li>
<li><p>The <a href="../../can-define-stream-kefir.html" title="Exports a function that takes a Type map or list and uses can-stream-kefir to create a streaming object">can-define-stream-kefir</a> module adds a <code>map.toStream</code> method which is an alias for
<code>canStream.toStream</code>.  Use it to create streams from properties and events on a map instance like:</p>
<pre><code class="language-js">var Person = can.DefineMap.extend({
    name: &quot;string&quot;
});

var me = new Person({name: &quot;Justin&quot;});

var nameStream = me.toStream(&quot;.name&quot;);

nameStream.onValue(function(){ ... })
</code></pre></li>
</ul>
<h3>The solution</h3>
<p>Update the <code>JS</code> tab to:</p>
<ul>
<li>Mixin <a href="../../can-define-stream-kefir.html" title="Exports a function that takes a Type map or list and uses can-stream-kefir to create a streaming object">can-define-stream-kefir</a> into the <code>WeatherViewModel</code>.</li>
<li>Remove the setter side-effects from <code>location</code></li>
<li>Change <code>place</code> to derive its value from:
<ul>
<li>changes in <code>location</code> -  <code>place</code> should be <code>null</code> if <code>location</code> changes.</li>
<li>the <code>.places</code> value - <code>place</code> should be the one and only <em>place</em> in <code>places</code> if there is only one <em>place</em> in <code>places</code>.</li>
<li>the set <code>.place</code> value.</li>
</ul></li>
</ul>
<pre><code class="language-js">var yqlURL = &quot;https://query.yahooapis.com/v1/public/yql?&quot;;

var WeatherViewModel = can.DefineMap.extend({
    location: &quot;string&quot;,
    get placesPromise() {
        if (this.location &amp;&amp; this.location.length &gt; 2) {
            return fetch(
                yqlURL +
                can.param({
                    q: 'select * from geo.places where text=&quot;' + this.location + '&quot;',
                    format: &quot;json&quot;
                })
            ).then(function(response) {
                return response.json();
            }).then(function(data) {
                console.log(data);
                if (Array.isArray(data.query.results.place)) {
                    return data.query.results.place;
                } else {
                    return [data.query.results.place];
                }
            });
        }
    },
    places: {
        get: function(latSet, resolve) {
            if (this.placesPromise) {
                this.placesPromise.then(resolve);
            }
        }
    },
    get showPlacePicker() {
        return !this.place &amp;&amp; this.places &amp;&amp; this.places.length &gt; 1;
    },
    place: {
        stream: function(setStream) {
            var resetStream = this.toStream(&quot;.location&quot;).map(function() {
                return null;
            });
            var onePlaceResultStream = this.toStream(&quot;.places&quot;).map(function(places){
                if(places.length === 1) {
                    return places[0];
                } else {
                    return null;
                }
            });

            return onePlaceResultStream
                .merge(setStream)
                .merge(resetStream);
        }
    },
    pickPlace: function(place) {
        this.place = place;
    },
    get forecastPromise() {
        if (this.place) {
            console.log(&quot;place&quot;, this.place);
            return fetch(
                yqlURL +
                can.param({
                    q: 'select * from weather.forecast where woeid=' + this.place.woeid,
                    format: &quot;json&quot;
                })
            ).then(function(response) {
                return response.json();
            }).then(function(data) {
                console.log(&quot;forecast data&quot;, data);
                var forecast = data.query.results.channel.item.forecast;

                return forecast;
            });
        }
    },
    toClassName: function(text) {
        return text.toLowerCase().replace(/ /g, &quot;-&quot;);
    }
});
can.defineStreamKefir(WeatherViewModel);

var vm = new WeatherViewModel();

var template = can.stache.from(&quot;app-template&quot;);
var frag = template(vm);
document.body.appendChild(frag);

</code></pre>
<p><span line-highlight='4,35-52,79,only'></span></p>
<h2>Get the geoLocation’s latitude and longitude</h2>
<h3>The problem</h3>
<p>Instead of requiring the user to search for their city,
let’s change the app to use the browser’s <a href="https://developer.mozilla.org/en-US/docs/Web/API/Geolocation/Using_geolocation">geolocation</a> API to look up their location.  For this step, we
will add the following behaviors:</p>
<ul>
<li>If the user enables location services, we will write their latitude and longitude.</li>
<li>If the user disables location services or there is some other type of error,
we will print the error message.</li>
</ul>
<p>We will do this by:</p>
<ul>
<li>Creating a Kefir stream of the User’s position or error messages.</li>
<li>Using that stream to create the <code>geoLocation</code> and <code>geoLocationError</code> properties.</li>
<li>Displaying the data of those properties in the template.</li>
</ul>
<h3>What you need to know</h3>
<ul>
<li><p>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/Geolocation/Using_geolocation">geolocation</a>
API allows you to <em>request</em> the user’s position as follows:</p>
<pre><code class="language-js">navigator.geolocation.getCurrentPosition(
    function(position){...},
    function(err){...});
</code></pre></li>
<li><p>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/Geolocation/Using_geolocation">geolocation</a>
API allows you to <em>monitor changes</em> in the user’s position as follows:</p>
<pre><code class="language-js">var watch = navigator.geolocation.watchPosition(
    function(position){...},
    function(err){...});
</code></pre>
<p>To cancel watching, call:</p>
<pre><code class="language-js">navigator.geolocation.clearWatch(watch);
</code></pre></li>
<li><p>To create a <code>Kefir</code> stream, call <code>Kefir.stream</code> as follows:</p>
<pre><code class="language-js">var myStream = Kefir.stream(function setup(emitter){

    // INITIALIZATION CODE

    return function teardown(){
        // TEARDOWN CODE
    }
});
</code></pre>
<p><code>Kefir.stream</code> is passed an event emitter which can emit values like:</p>
<pre><code class="language-js">emitter.value(123);
</code></pre>
<p>or errors like:</p>
<pre><code class="language-js">emitter.error(&quot;something went wrong&quot;);
</code></pre>
<p>or end the stream of values like:</p>
<pre><code class="language-js">emitter.end();
</code></pre>
<p>Typically, you listen to sources and emit values in the <code>setup</code> function
and stop listening to sources in the <code>teardown</code> function.  For example,
the following might listen to where the user’s mouse is on the page:</p>
<pre><code class="language-js">var cursorPosition = Kefir.stream(function(emitter){
    var handler = function(ev){
        emitter.emit({pageX: ev.pageX, pageY: pageY});
    };
    document.documentElement.addEventListener(&quot;mousemove&quot;,handler);

    return function(){
        document.documentElement.removeEventListener(&quot;mousemove&quot;,handler);
    }
})
</code></pre></li>
<li><p>Kefir’s <code>stream.withHandler( handler(emitter, event) )</code> is able to convert one stream’s events to another stream. All other stream methods like <code>stream.map</code> and <code>stream.scan</code> can be implemented with <code>stream.withHandler</code>. For example, the following maps the <code>cursorPosition</code> stream to a <code>cursorDistance</code> stream:</p>
<pre><code class="language-js">cursorDistance = cursorPosition.withHandler(function(emitter, event){
    if (event.type === 'end') {
      emitter.end();
    }
    if (event.type === 'error') {
      emitter.error(event.value);
    }
    if (event.type === 'value') {
      var pageX = event.value.pageX;
      var pageY = event.value.pageY;
      emitter.value( Math.sqrt(pageX*pageX + pageY*pageY) );
    }
});
</code></pre>
<p>Notice how <code>withHandler</code> is called with the emitter of <code>cursorDistance</code>
and the events of <code>cursorPosition</code>.</p></li>
</ul>
<h3>The solution</h3>
<pre><code class="language-js">var yqlURL = &quot;https://query.yahooapis.com/v1/public/yql?&quot;;

var geoLocationStream = Kefir.stream(function(emitter) {
    navigator.geolocation.getCurrentPosition(function(position){
      emitter.value(position);
    }, function(err){
        console.log(&quot;getCurrentPositionErr&quot;,err);
        emitter.error(err);
    });


     var watch = navigator.geolocation.watchPosition(function(position){
       emitter.value(position);
     }, function(err){
         emitter.error(err);
     });

    return function() {
        navigator.geolocation.clearWatch(watch);
    };
});

var WeatherViewModel = can.DefineMap.extend({
    geoLocation: {
        stream: function() {
            return geoLocationStream;
        }
    },
    geoLocationError: {
        stream: function() {
            return geoLocationStream.withHandler(function(emitter, event){
                if (event.type === 'end') {
                    emitter.end();
                }
                if (event.type === 'error') {
                    emitter.value(event.value);
                }
            });
        }
    },
    location: &quot;string&quot;,
    get placesPromise() {
        if (this.location &amp;&amp; this.location.length &gt; 2) {
            return fetch(
                yqlURL +
                can.param({
                    q: 'select * from geo.places where text=&quot;' + this.location + '&quot;',
                    format: &quot;json&quot;
                })
            ).then(function(response) {
                return response.json();
            }).then(function(data) {
                console.log(data);
                if (Array.isArray(data.query.results.place)) {
                    return data.query.results.place;
                } else {
                    return [data.query.results.place];
                }
            });
        }
    },
    places: {
        get: function(latSet, resolve) {
            if (this.placesPromise) {
                this.placesPromise.then(resolve);
            }
        }
    },
    get showPlacePicker() {
        return !this.place &amp;&amp; this.places &amp;&amp; this.places.length &gt; 1;
    },
    place: {
        stream: function(setStream) {
            var resetStream = this.toStream(&quot;.location&quot;).map(function() {
                return null;
            });
            var onePlaceResultStream = this.toStream(&quot;.places&quot;).map(function(places){
                if(places.length === 1) {
                    return places[0];
                } else {
                    return null;
                }
            });

            return onePlaceResultStream
                .merge(setStream)
                .merge(resetStream);
        }
    },
    pickPlace: function(place) {
        this.place = place;
    },
    get forecastPromise() {
        if (this.place) {
            console.log(&quot;place&quot;, this.place);
            return fetch(
                yqlURL +
                can.param({
                    q: 'select * from weather.forecast where woeid=' + this.place.woeid,
                    format: &quot;json&quot;
                })
            ).then(function(response) {
                return response.json();
            }).then(function(data) {
                console.log(&quot;forecast data&quot;, data);
                var forecast = data.query.results.channel.item.forecast;

                return forecast;
            });
        }
    },
    toClassName: function(text) {
        return text.toLowerCase().replace(/ /g, &quot;-&quot;);
    }
});
can.defineStreamKefir(WeatherViewModel);

var vm = new WeatherViewModel();

var template = can.stache.from(&quot;app-template&quot;);
var frag = template(vm);
document.body.appendChild(frag);

</code></pre>
<p><span line-highlight='3-21,24-40,only'></span></p>
<pre><code class="language-html">Latitude: {{geoLocation.coords.latitude}},
Longitude: {{geoLocation.coords.longitude}},
Error: {{geoLocationError.message}}

&lt;div class=&quot;weather-widget&quot;&gt;

  &lt;div class=&quot;location-entry&quot;&gt;
    &lt;label for=&quot;location&quot;&gt;Enter Your location:&lt;/label&gt;
    &lt;input id=&quot;location&quot; {^$value}=&quot;location&quot; type=&quot;text&quot;/&gt;
  &lt;/div&gt;

  {{#if placesPromise.isPending}}
    &lt;p class=&quot;loading-message&quot;&gt;
      Loading places…
    &lt;/p&gt;
  {{/if}}

  {{#if showPlacePicker}}
    &lt;div class=&quot;location-options&quot;&gt;
      &lt;label&gt;Pick your place:&lt;/label&gt;
      &lt;ul&gt;
        {{#each placesPromise.value}}
          &lt;li ($click)=&quot;../pickPlace(this)&quot;&gt;{{name}}, {{admin1.content}},
              {{country.code}} ({{placeTypeName.content}})&lt;/li&gt;
        {{/each}}
      &lt;/ul&gt;
    &lt;/div&gt;
  {{/if}}

  {{#if place}}
    &lt;div class=&quot;forecast&quot;&gt;
      &lt;h1&gt;10 day {{place.name}} Weather Forecast&lt;/h1&gt;
      &lt;ul&gt;
        {{#each forecastPromise.value}}
          &lt;li&gt;
            &lt;span class='date'&gt;{{date}}&lt;/span&gt;
            &lt;span class='description {{toClassName(text)}}'&gt;{{text}}&lt;/span&gt;
            &lt;span class='high-temp'&gt;{{high}}&lt;sup&gt;&amp;deg;&lt;/sup&gt;&lt;/span&gt;
            &lt;span class='low-temp'&gt;{{low}}&lt;sup&gt;&amp;deg;&lt;/sup&gt;&lt;/span&gt;
          &lt;/li&gt;
        {{/each}}
      &lt;/ul&gt;
    &lt;/div&gt;
  {{/if}}

&lt;/div&gt;

</code></pre>
<p><span line-highlight='1-3,only'></span></p>
<h2>Find the user’s place by latitude and longitude</h2>
<h3>The problem</h3>
<p>We need to get which place the user is in by their
latitude and longitude. We will save this place as the
<code>geoPlace</code> property and use it in the <code>place</code> property definition.</p>
<h3>What you need to know</h3>
<p>Flickr has an API that can get a place that is recognized by
Yahoo’s weather APIs.  It can be retrieved with <code>fetch</code> like:</p>
<pre><code class="language-js">fetch(&quot;https://api.flickr.com/services/rest/?&quot;+
    can.param({
        method: &quot;flickr.places.findByLatLon&quot;,
        api_key: &quot;df0a221bb43ecbc2abb03426bd84e598&quot;,
        lat: LATITUDE,
        lon: LONGITUDE,
        format: &quot;json&quot;,
        nojsoncallback: 1
    })
).then(function(response){
    return response.json()
}).then(function(responseJSON){
    return responseJSON.places.place[0];
});
</code></pre>
<h3>The solution</h3>
<pre><code class="language-js">var yqlURL = &quot;https://query.yahooapis.com/v1/public/yql?&quot;;

var geoLocationStream = Kefir.stream(function(emitter) {
    navigator.geolocation.getCurrentPosition(function(position){
      emitter.value(position);
    }, function(err){
        console.log(&quot;getCurrentPositionErr&quot;,err);
        emitter.error(err);
    });


     var watch = navigator.geolocation.watchPosition(function(position){
       emitter.value(position);
     }, function(err){
         emitter.error(err);
     });

    return function() {
        navigator.geolocation.clearWatch(watch);
    };
});

var WeatherViewModel = can.DefineMap.extend({
    geoLocation: {
        stream: function() {
            return geoLocationStream;
        }
    },
    geoLocationError: {
        stream: function() {
            return geoLocationStream.withHandler(function(emitter, event){
                if (event.type === 'end') {
                    emitter.end();
                }
                if (event.type === 'error') {
                    emitter.value(event.value);
                }
            });
        }
    },
    geoPlace: {
        get: function(lastSet, resolve) {
            if (this.geoLocation) {
                fetch(&quot;https://api.flickr.com/services/rest/?&quot; +
                    can.param({
                        method: &quot;flickr.places.findByLatLon&quot;,
                        api_key: &quot;df0a221bb43ecbc2abb03426bd84e598&quot;,
                        lat: this.geoLocation.coords.latitude,
                        lon: this.geoLocation.coords.longitude,
                        format: &quot;json&quot;,
                        nojsoncallback: 1
                    })
                ).then(function(response){
                    return response.json();
                }).then(function(responseJSON){
                    return responseJSON.places.place[0];
                }).then(resolve);
            }
        }
    },
    location: &quot;string&quot;,
    get placesPromise() {
        if (this.location &amp;&amp; this.location.length &gt; 2) {
            return fetch(
                yqlURL +
                can.param({
                    q: 'select * from geo.places where text=&quot;' + this.location + '&quot;',
                    format: &quot;json&quot;
                })
            ).then(function(response) {
                return response.json();
            }).then(function(data) {
                console.log(data);
                if (Array.isArray(data.query.results.place)) {
                    return data.query.results.place;
                } else {
                    return [data.query.results.place];
                }
            });
        }
    },
    places: {
        get: function(latSet, resolve) {
            if (this.placesPromise) {
                this.placesPromise.then(resolve);
            }
        }
    },
    get showPlacePicker() {
        return !this.place &amp;&amp; this.places &amp;&amp; this.places.length &gt; 1;
    },
    place: {
        stream: function(setStream) {
            var resetStream = this.toStream(&quot;.location&quot;).map(function() {
                return null;
            });
            var onePlaceResultStream = this.toStream(&quot;.places&quot;).map(function(places){
                if(places.length === 1) {
                    return places[0];
                } else {
                    return null;
                }
            });

            return onePlaceResultStream
                .merge(setStream)
                .merge(resetStream)
                .merge(this.toStream(&quot;.geoPlace&quot;));
        }
    },
    pickPlace: function(place) {
        this.place = place;
    },
    get forecastPromise() {
        if (this.place) {
            console.log(&quot;place&quot;, this.place);
            return fetch(
                yqlURL +
                can.param({
                    q: 'select * from weather.forecast where woeid=' + this.place.woeid,
                    format: &quot;json&quot;
                })
            ).then(function(response) {
                return response.json();
            }).then(function(data) {
                console.log(&quot;forecast data&quot;, data);
                var forecast = data.query.results.channel.item.forecast;

                return forecast;
            });
        }
    },
    toClassName: function(text) {
        return text.toLowerCase().replace(/ /g, &quot;-&quot;);
    }
});
can.defineStreamKefir(WeatherViewModel);

var vm = new WeatherViewModel();

var template = can.stache.from(&quot;app-template&quot;);
var frag = template(vm);
document.body.appendChild(frag);

</code></pre>
<p><span line-highlight='41-60,108,only'></span></p>
<h2>Add &quot;Enable Location Services&quot; message</h2>
<h3>The problem</h3>
<p>When a user first views the page, they will be prompted to enable location
services. While they are prompted, we will display a <code>Please Enable Location Services…</code> message.</p>
<h3>What you need to know</h3>
<p>Display the message while <code>geoLocation</code> and <code>geoLocationError</code> are undefined.</p>
<h3>The solution</h3>
<pre><code class="language-js">var yqlURL = &quot;https://query.yahooapis.com/v1/public/yql?&quot;;

var geoLocationStream = Kefir.stream(function(emitter) {
    navigator.geolocation.getCurrentPosition(function(position){
      emitter.value(position);
    }, function(err){
        console.log(&quot;getCurrentPositionErr&quot;,err);
        emitter.error(err);
    });


     var watch = navigator.geolocation.watchPosition(function(position){
       emitter.value(position);
     }, function(err){
         emitter.error(err);
     });

    return function() {
        navigator.geolocation.clearWatch(watch);
    };
});

var WeatherViewModel = can.DefineMap.extend({
    geoLocation: {
        stream: function() {
            return geoLocationStream;
        }
    },
    geoLocationError: {
        stream: function() {
            return geoLocationStream.withHandler(function(emitter, event){
                if (event.type === 'end') {
                    emitter.end();
                }
                if (event.type === 'error') {
                    emitter.value(event.value);
                }
            });
        }
    },
    geoPlace: {
        get: function(lastSet, resolve) {
            if (this.geoLocation) {
                fetch(&quot;https://api.flickr.com/services/rest/?&quot; +
                    can.param({
                        method: &quot;flickr.places.findByLatLon&quot;,
                        api_key: &quot;df0a221bb43ecbc2abb03426bd84e598&quot;,
                        lat: this.geoLocation.coords.latitude,
                        lon: this.geoLocation.coords.longitude,
                        format: &quot;json&quot;,
                        nojsoncallback: 1
                    })
                ).then(function(response){
                    return response.json();
                }).then(function(responseJSON){
                    return responseJSON.places.place[0];
                }).then(resolve);
            }
        }
    },
    get showEnableGeoLocationMessage(){
        return !this.geoLocation &amp;&amp; !this.geoLocationError;
    },
    location: &quot;string&quot;,
    get placesPromise() {
        if (this.location &amp;&amp; this.location.length &gt; 2) {
            return fetch(
                yqlURL +
                can.param({
                    q: 'select * from geo.places where text=&quot;' + this.location + '&quot;',
                    format: &quot;json&quot;
                })
            ).then(function(response) {
                return response.json();
            }).then(function(data) {
                console.log(data);
                if (Array.isArray(data.query.results.place)) {
                    return data.query.results.place;
                } else {
                    return [data.query.results.place];
                }
            });
        }
    },
    places: {
        get: function(latSet, resolve) {
            if (this.placesPromise) {
                this.placesPromise.then(resolve);
            }
        }
    },
    get showPlacePicker() {
        return !this.place &amp;&amp; this.places &amp;&amp; this.places.length &gt; 1;
    },
    place: {
        stream: function(setStream) {
            var resetStream = this.toStream(&quot;.location&quot;).map(function() {
                return null;
            });
            var onePlaceResultStream = this.toStream(&quot;.places&quot;).map(function(places){
                if(places.length === 1) {
                    return places[0];
                } else {
                    return null;
                }
            });

            return onePlaceResultStream
                .merge(setStream)
                .merge(resetStream)
                .merge(this.toStream(&quot;.geoPlace&quot;));
        }
    },
    pickPlace: function(place) {
        this.place = place;
    },
    get forecastPromise() {
        if (this.place) {
            console.log(&quot;place&quot;, this.place);
            return fetch(
                yqlURL +
                can.param({
                    q: 'select * from weather.forecast where woeid=' + this.place.woeid,
                    format: &quot;json&quot;
                })
            ).then(function(response) {
                return response.json();
            }).then(function(data) {
                console.log(&quot;forecast data&quot;, data);
                var forecast = data.query.results.channel.item.forecast;

                return forecast;
            });
        }
    },
    toClassName: function(text) {
        return text.toLowerCase().replace(/ /g, &quot;-&quot;);
    }
});
can.defineStreamKefir(WeatherViewModel);

var vm = new WeatherViewModel();

var template = can.stache.from(&quot;app-template&quot;);
var frag = template(vm);
document.body.appendChild(frag);

</code></pre>
<p><span line-highlight='61-63,only'></span></p>
<pre><code class="language-html">Latitude: {{geoLocation.coords.latitude}},
Longitude: {{geoLocation.coords.longitude}},
Error: {{geoLocationError.message}}

&lt;div class=&quot;weather-widget&quot;&gt;
  {{#if showEnableGeoLocationMessage}}
    &lt;p class=&quot;loading-message&quot;&gt;
      Please Enable Location Services…
    &lt;/p&gt;
  {{/if}}

  &lt;div class=&quot;location-entry&quot;&gt;
    &lt;label for=&quot;location&quot;&gt;Enter Your location:&lt;/label&gt;
    &lt;input id=&quot;location&quot; {^$value}=&quot;location&quot; type=&quot;text&quot;/&gt;
  &lt;/div&gt;

  {{#if placesPromise.isPending}}
    &lt;p class=&quot;loading-message&quot;&gt;
      Loading places…
    &lt;/p&gt;
  {{/if}}

  {{#if showPlacePicker}}
    &lt;div class=&quot;location-options&quot;&gt;
      &lt;label&gt;Pick your place:&lt;/label&gt;
      &lt;ul&gt;
        {{#each placesPromise.value}}
          &lt;li ($click)=&quot;../pickPlace(this)&quot;&gt;{{name}}, {{admin1.content}},
              {{country.code}} ({{placeTypeName.content}})&lt;/li&gt;
        {{/each}}
      &lt;/ul&gt;
    &lt;/div&gt;
  {{/if}}

  {{#if place}}
    &lt;div class=&quot;forecast&quot;&gt;
      &lt;h1&gt;10 day {{place.name}} Weather Forecast&lt;/h1&gt;
      &lt;ul&gt;
        {{#each forecastPromise.value}}
          &lt;li&gt;
            &lt;span class='date'&gt;{{date}}&lt;/span&gt;
            &lt;span class='description {{toClassName(text)}}'&gt;{{text}}&lt;/span&gt;
            &lt;span class='high-temp'&gt;{{high}}&lt;sup&gt;&amp;deg;&lt;/sup&gt;&lt;/span&gt;
            &lt;span class='low-temp'&gt;{{low}}&lt;sup&gt;&amp;deg;&lt;/sup&gt;&lt;/span&gt;
          &lt;/li&gt;
        {{/each}}
      &lt;/ul&gt;
    &lt;/div&gt;
  {{/if}}

&lt;/div&gt;

</code></pre>
<p><span line-highlight='6-10,only'></span></p>
<h2>Allow user to enter location only if location services failed</h2>
<h3>The problem</h3>
<p>Show the location entry <code>&lt;div&gt;</code> only when geo location has failed.</p>
<h3>What you need to know</h3>
<p>Nothing, you've learned it all by this point.  Apply what you know!</p>
<h3>The solution</h3>
<pre><code class="language-js">var yqlURL = &quot;https://query.yahooapis.com/v1/public/yql?&quot;;

var geoLocationStream = Kefir.stream(function(emitter) {
    navigator.geolocation.getCurrentPosition(function(position){
      emitter.value(position);
    }, function(err){
        console.log(&quot;getCurrentPositionErr&quot;,err);
        emitter.error(err);
    });


     var watch = navigator.geolocation.watchPosition(function(position){
       emitter.value(position);
     }, function(err){
         emitter.error(err);
     });

    return function() {
        navigator.geolocation.clearWatch(watch);
    };
});

var WeatherViewModel = can.DefineMap.extend({
    geoLocation: {
        stream: function() {
            return geoLocationStream;
        }
    },
    geoLocationError: {
        stream: function() {
            return geoLocationStream.withHandler(function(emitter, event){
                if (event.type === 'end') {
                    emitter.end();
                }
                if (event.type === 'error') {
                    emitter.value(event.value);
                }
            });
        }
    },
    geoPlace: {
        get: function(lastSet, resolve) {
            if (this.geoLocation) {
                fetch(&quot;https://api.flickr.com/services/rest/?&quot; +
                    can.param({
                        method: &quot;flickr.places.findByLatLon&quot;,
                        api_key: &quot;df0a221bb43ecbc2abb03426bd84e598&quot;,
                        lat: this.geoLocation.coords.latitude,
                        lon: this.geoLocation.coords.longitude,
                        format: &quot;json&quot;,
                        nojsoncallback: 1
                    })
                ).then(function(response){
                    return response.json();
                }).then(function(responseJSON){
                    return responseJSON.places.place[0];
                }).then(resolve);
            }
        }
    },
    get showEnableGeoLocationMessage(){
        return !this.geoLocation &amp;&amp; !this.geoLocationError;
    },
    get showEnterLocation(){
        return !!this.geoLocationError;
    },
    location: &quot;string&quot;,
    get placesPromise() {
        if (this.location &amp;&amp; this.location.length &gt; 2) {
            return fetch(
                yqlURL +
                can.param({
                    q: 'select * from geo.places where text=&quot;' + this.location + '&quot;',
                    format: &quot;json&quot;
                })
            ).then(function(response) {
                return response.json();
            }).then(function(data) {
                console.log(data);
                if (Array.isArray(data.query.results.place)) {
                    return data.query.results.place;
                } else {
                    return [data.query.results.place];
                }
            });
        }
    },
    places: {
        get: function(latSet, resolve) {
            if (this.placesPromise) {
                this.placesPromise.then(resolve);
            }
        }
    },
    get showPlacePicker() {
        return !this.place &amp;&amp; this.places &amp;&amp; this.places.length &gt; 1;
    },
    place: {
        stream: function(setStream) {
            var resetStream = this.toStream(&quot;.location&quot;).map(function() {
                return null;
            });
            var onePlaceResultStream = this.toStream(&quot;.places&quot;).map(function(places){
                if(places.length === 1) {
                    return places[0];
                } else {
                    return null;
                }
            });

            return onePlaceResultStream
                .merge(setStream)
                .merge(resetStream)
                .merge(this.toStream(&quot;.geoPlace&quot;));
        }
    },
    pickPlace: function(place) {
        this.place = place;
    },
    get forecastPromise() {
        if (this.place) {
            console.log(&quot;place&quot;, this.place);
            return fetch(
                yqlURL +
                can.param({
                    q: 'select * from weather.forecast where woeid=' + this.place.woeid,
                    format: &quot;json&quot;
                })
            ).then(function(response) {
                return response.json();
            }).then(function(data) {
                console.log(&quot;forecast data&quot;, data);
                var forecast = data.query.results.channel.item.forecast;

                return forecast;
            });
        }
    },
    toClassName: function(text) {
        return text.toLowerCase().replace(/ /g, &quot;-&quot;);
    }
});
can.defineStreamKefir(WeatherViewModel);

var vm = new WeatherViewModel();

var template = can.stache.from(&quot;app-template&quot;);
var frag = template(vm);
document.body.appendChild(frag);

</code></pre>
<p><span line-highlight='64-66,only'></span></p>
<pre><code class="language-html">Latitude: {{geoLocation.coords.latitude}},
Longitude: {{geoLocation.coords.longitude}},
Error: {{geoLocationError.message}}

&lt;div class=&quot;weather-widget&quot;&gt;
  {{#if showEnableGeoLocationMessage}}
    &lt;p class=&quot;loading-message&quot;&gt;
      Please Enable Location Services…
    &lt;/p&gt;
  {{/if}}

  {{#if showEnterLocation}}
    &lt;div class=&quot;location-entry&quot;&gt;
      &lt;label for=&quot;location&quot;&gt;Enter Your location:&lt;/label&gt;
      &lt;input id=&quot;location&quot; {^$value}=&quot;location&quot; type=&quot;text&quot;/&gt;
    &lt;/div&gt;
  {{/if}}

  {{#if placesPromise.isPending}}
    &lt;p class=&quot;loading-message&quot;&gt;
      Loading places…
    &lt;/p&gt;
  {{/if}}

  {{#if showPlacePicker}}
    &lt;div class=&quot;location-options&quot;&gt;
      &lt;label&gt;Pick your place:&lt;/label&gt;
      &lt;ul&gt;
        {{#each placesPromise.value}}
          &lt;li ($click)=&quot;../pickPlace(this)&quot;&gt;{{name}}, {{admin1.content}},
              {{country.code}} ({{placeTypeName.content}})&lt;/li&gt;
        {{/each}}
      &lt;/ul&gt;
    &lt;/div&gt;
  {{/if}}

  {{#if place}}
    &lt;div class=&quot;forecast&quot;&gt;
      &lt;h1&gt;10 day {{place.name}} Weather Forecast&lt;/h1&gt;
      &lt;ul&gt;
        {{#each forecastPromise.value}}
          &lt;li&gt;
            &lt;span class='date'&gt;{{date}}&lt;/span&gt;
            &lt;span class='description {{toClassName(text)}}'&gt;{{text}}&lt;/span&gt;
            &lt;span class='high-temp'&gt;{{high}}&lt;sup&gt;&amp;deg;&lt;/sup&gt;&lt;/span&gt;
            &lt;span class='low-temp'&gt;{{low}}&lt;sup&gt;&amp;deg;&lt;/sup&gt;&lt;/span&gt;
          &lt;/li&gt;
        {{/each}}
      &lt;/ul&gt;
    &lt;/div&gt;
  {{/if}}

&lt;/div&gt;

</code></pre>
<p><span line-highlight='12,17,only'></span></p>
<h2>Result</h2>
<p>When finished, you should see something like the following JS Bin:</p>
<p><a class="jsbin-embed" href="https://jsbin.com/jipevu/2/embed?html,js,output">JS Bin on jsbin.com</a></p>
<script src="https://static.jsbin.com/js/embed.min.js?4.0.0"></script>

</section>

  


<script type="text/javascript">
  window.docObject = {"src":{"path":"docs/can-guides/commitment/recipes/weather-report/weather-report-advanced.md"},"description":"This guides you through extending the [guides/recipes/weather-report-simple Simple Weather Report Guide] to remove imperative code and automatically look up the user’s location using the\nbrowser’s [geolocation API](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation/Using_geolocation).  Both of these will be done with event streams.\n\nThis guide continues where the [guides/recipes/weather-report-simple Simple Weather Report Guide] left off.  It takes about 25 minutes to complete.  It was written with CanJS 3.8.\n\n","name":"guides/recipes/weather-report-advanced","title":"Weather Report Guide (Advanced)","type":"page","parent":"guides/recipes","comment":" ","pathToRoot":"../.."};
</script>
</article>
	  
        <footer><p>CanJS is part of <a href="https://donejs.com" target="_blank">DoneJS</a>. Created and maintained by the core <a href="https://donejs.com/About.html#team" target="_blank">DoneJS team</a> and <a href="https://www.bitovi.com" target="_blank">Bitovi</a>. <strong>Currently 3.8.1.</strong></p>
</footer>
	      </div>
  </div>
</div>

		
			<script>
				steal = {
				  	instantiated: {
				    	"bundles/bit-docs-site/static.css!$css" : null
				  	}
			  	};
			</script>
			<script type='text/javascript' data-main="bit-docs-site/static" src="../../static/node_modules/steal/steal.production.js"></script>
		
		<script async defer src="https://buttons.github.io/buttons.js"></script>

		<!-- root-level elements with attributes necessary for the app -->
		<div path-prefix="../.." />
		
	</body>
</html>
